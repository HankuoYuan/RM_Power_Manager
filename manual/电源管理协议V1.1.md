# 电源管理接口协议V1.1
### 修订日志

|    日期    | 版本 |             改动记录             |
| :--------: | :--: | :------------------------------: |
| 2023.05.17 | V1.1 | 增加异常命令并修改状态回传的数据 |
| 2023.05.03 | V1.0 |             首次发布             |

### 命令码ID说明

| 命令码 | 数据段长度 |         功能说明         |
| :----: | :--------: | :----------------------: |
| 0x8301 |     10     | 电源管理的采样数据及状态 |
| 0x8302 |     32     |    电源管理初始化异常    |
| 0x8303 |     32     |     电源管理系统异常     |
| 0x8304 |     32     |    电源管理进程栈溢出    |
| 0x8305 |     2      |     电源管理未知异常     |

### 详细说明

1. 电源管理功率数据 `0x8301`，发送频率20Hz：
   
   | 字节偏移量 | 大小 |                             说明                             |
   | :--------: | :--: | :----------------------------------------------------------: |
   |     0      |  1   |             底盘功率（单位W）扩大100倍后的高8位              |
   |     1      |  1   |             底盘功率（单位W）扩大100倍后的低8位              |
   |     2      |  1   |           底盘期望功率（单位W）扩大100倍后的高8位            |
   |     3      |  1   |           底盘期望功率（单位W）扩大100倍后的低8位            |
   |     4      |  1   |          电容组充电功率（单位W）扩大100倍后的高8位           |
   |     5      |  1   |          电容组充电功率（单位W）扩大100倍后的低8位           |
   |     6      |  1   |             电容组剩余电量（单位万分之一）高8位              |
   |     7      |  1   |             电容组剩余电量（单位万分之一）低8位              |
   |     8      |  1   |                  当前电容充电功率（单位W）                   |
   |     9      |  1   | 4~7bit：状态机模式<br>0：charge mode<br>1：boost mode<br>2：normal mode<br>3：all off mode<br><br>0~3bit：电源管理拓扑<br>0：pass through<br>1：charge and boost<br>2：switches all off<br> |
   
2. 电源管理初始化异常 `0x8302`，异常时发送：
   
   | 字节偏移量 | 大小 |                   说明                    |
   | :--------: | :--: | :---------------------------------------: |
   | 0 | 1 | 初始化异常所在的行 |
   | 1 | 31 | 初始化异常所在的文件名 |

3. 电源管理系统异常 `0x8303`，异常时发送：
   
   | 字节偏移量 | 大小 |                   说明                    |
   | :--------: | :--: | :---------------------------------------: |
   | 0 | 4 | 异常时R0的值，uint32类型 |
   | 3 | 4 | 异常时R1的值，uint32类型 |
   | 7 | 4 | 异常时R2的值，uint32类型 |
   | 11 | 4 | 异常时R3的值，uint32类型 |
   | 15 | 4 | 异常时R12的值，uint32类型 |
   | 19 | 4 | 异常时LR的值，uint32类型 |
   | 23 | 4 | 异常时PC的值，uint32类型 |
   | 27 | 4 | 异常时PSR的值，uint32类型 |

4. 电源管理进程栈溢出 `0x8304`，异常时发送：
   
   | 字节偏移量 | 大小 |                   说明                    |
   | :--------: | :--: | :---------------------------------------: |
   | 0 | 32 | 栈溢出的进程名 |

5. 电源管理未知异常 `0x8305`，异常时发送：

   | 字节偏移量 | 大小 |                   说明                    |
   | :--------: | :--: | :---------------------------------------: |
   | 0 | 1 | 异常复位原因<br>1：上电复位<br>2：外部按键复位<br>3：软件复位<br>4：独立看门狗复位<br>5：窗口看门狗复位<br>6：低电压复位<br>7：其它未知原因复位 |
   | 1 | 1 | 4~7bit：复位前状态机模式<br>0：charge mode<br>1：boost mode<br>2：normal mode<br>3：all off mode<br><br>0~3bit：复位前电源管理拓扑<br>0：pass through<br>1：charge and boost<br>2：switches all off |